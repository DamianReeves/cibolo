package ndoctrinate:components@0.1.0;

/// Parser component interface.
/// Parsers convert input (text or binary) into an Abstract Syntax Tree (AST).
interface parser {
  use ndoctrinate:types/vfile@0.1.0.{virtual-file};
  use ndoctrinate:types/ast@0.1.0.{syntax-tree};
  use ndoctrinate:types/errors@0.1.0.{parse-error};

  /// Parse input into a syntax tree.
  ///
  /// Takes a virtual file containing the input content and converts it
  /// into a structured syntax tree representation.
  ///
  /// # Parameters
  /// - `file`: Virtual file containing the content to parse
  ///
  /// # Returns
  /// - `Ok(parse-result)`: Successfully parsed syntax tree and updated file
  /// - `Err(parse-error)`: Parsing failed with error details
  ///
  /// # Notes
  /// - The parser may add messages (warnings, info) to the file even on success
  /// - The returned file may have modified metadata (e.g., frontmatter extraction)
  /// - Parsers should be pure and not have side effects
  parse: func(file: virtual-file) -> result<parse-result, parse-error>;

  /// Result of a successful parse operation.
  /// Includes both the syntax tree and the (potentially modified) virtual file.
  record parse-result {
    /// The parsed syntax tree
    tree: syntax-tree,
    /// The virtual file (may include added messages or updated metadata)
    file: virtual-file,
  }

  /// Get information about this parser.
  /// Returns metadata about the parser's capabilities and configuration.
  get-info: func() -> parser-info;

  /// Parser metadata and capabilities.
  record parser-info {
    /// Parser name/identifier (e.g., "markdown-parser", "asciidoc-parser")
    name: string,
    /// Human-readable description
    description: string,
    /// Version of the parser
    version: string,
    /// Supported input formats/MIME types
    /// Example: ["text/markdown", "text/x-markdown"]
    supported-formats: list<string>,
    /// Optional configuration schema (JSON Schema as string)
    config-schema: option<string>,
  }

  /// Configure the parser with options.
  /// Allows runtime configuration of parser behavior.
  ///
  /// # Parameters
  /// - `config`: JSON-encoded configuration object
  ///
  /// # Returns
  /// - `Ok(())`: Configuration applied successfully
  /// - `Err(string)`: Configuration error message
  ///
  /// # Notes
  /// - Configuration format is parser-specific
  /// - Refer to `parser-info.config-schema` for the expected structure
  configure: func(config: string) -> result<_, string>;
}

/// World for parser components.
/// Defines what a parser component exports to the host.
world parser-component {
  /// Export the parser interface
  export parser;
}
